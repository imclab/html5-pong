<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<title>Pong html5 Game</title>
	<script src="js/jquery/jquery-1.4.2.min.js"></script>
	<script src="js/jquery/plugins/jquery.hotkeys-0.7.9.js"></script>
	<style type="text/css">
		canvas {
			background-color: #000;
			position: fixed;
			top	: 0;
			left	: 0;
			width	: 100%;
			height	: 100%;
		}
	</style>
	<script src="http://cdn.socket.io/stable/socket.io.js"></script>
</head>
<body>
	<canvas id="viewport"></canvas>
<script>
/** return mouse position from dom event
 * - http://www.quirksmode.org/js/events_properties.html#position
*/
var mouse_pos_get	= function(e){
	var posx = 0;
	var posy = 0;
	if (!e) var e = window.event;
	if (e.pageX || e.pageY) 	{
		posx = e.pageX;
		posy = e.pageY;
	}
	else if (e.clientX || e.clientY) 	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}
	return {
		x	: posx,
		y	: posy
	}
}

jQuery(function(){
	return;
	jQuery(document).bind('keydown', 'w',function(event){
		console.log("w");
		return false;
	});
	
	var canvas	= document.getElementById('viewport');
	var ctx		= canvas.getContext('2d');
	var ctx_w	= 300;
	var ctx_h	= 150;
	var canvas_h	= $(canvas).height();
	var racket_h	= 15;
	var racket_w	= 5;
	var racket_off	= 10;
	
	/** Draw the net in the middle of the viewport
	*/
	var draw_net	= function(){
		var net_w	= 1;
		var dash_nb	= 15;
		var dash_h	= ctx_h / dash_nb;
		var dash_off	= 0.25*dash_h;
		ctx.fillStyle	= "rgb(255,255,255)";
		for(var i = 0; i < dash_nb; i++){
			ctx.fillRect(ctx_w/2-net_w/2, i*dash_h, net_w, dash_h - dash_off);					
		}
	}
	/** Draw score
	*/
	var draw_score	= function(score_l, score_r){
		var score_off	= 20;
		var score_y	= 20;
		ctx.font    	=  '20px _sans';
		ctx.fillStyle	= "rgb(255,255,255)";
		ctx.textAlign	= 'center';
		ctx.fillText(score_l, ctx_w/2-score_off, score_y);
		ctx.fillText(score_r, ctx_w/2+score_off, score_y);		
	}
	/**
	 * Draw ball
	*/
	var draw_ball	= function(ball_x, ball_y){
		var ball_w	= 3;
		var ball_h	= 3;
		ctx.fillStyle	= "rgb(255,255,255)";
		ctx.fillRect(ball_x-ball_w/2, ball_y-ball_h/2, ball_w, ball_h);
	}
	/**
	 * Draw a racket
	*/
	var draw_racket	= function(pos_y, left_right){
		var pos_x	= racket_off;
		if( left_right === "right" )	pos_x	= (ctx_w-1) - pos_x;

		ctx.clearRect(pos_x - racket_w/2, 0, racket_w, ctx_h);
		ctx.fillStyle = "rgb(255,255,255)";
		ctx.fillRect(pos_x - racket_w/2, pos_y-racket_h/2, racket_w, racket_h);		
	}
	
	
	if(true){
		draw_net();
		draw_score(0,0);
		draw_ball(40,40);
		jQuery(canvas).bind("mousemove", function(event){
			var mouse_pos	= mouse_pos_get(event);
			//console.log("y=",mouse_pos.y);
			// convert the pixel position in document into canvas coordinate
			var mouse_y	= (mouse_pos.y / canvas_h) * ctx_h;
	
			draw_racket(mouse_y, "left");
			draw_racket(mouse_y, "right");
		})
	}
})

var Game	= function(){
	var socket	= null;

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//		ctor/dtor						//
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	var ctor	= function(){
		socketCtor();
		userInputCtor();
	}
	var dtor	= function(){
		
	}
	
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//		websocket						//
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	var socketCtor	= function(){
		socket = new io.Socket('localhost', {port: 8080});
		socket.on('connect', function(){
			// connected
			console.log("Websocket Connected to server");
		});
		socket.on('message', onMessage);		
		socket.connect();
	}
	var onMessage	= function(message){
		var data	= JSON.parse(message);
		console.log('got some data');
		console.dir(data);
	}
	
	
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//		userInput						//
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	var userInputCtor	= function(){
		var canvas	= document.getElementById('viewport');
		jQuery(canvas).bind("mousemove", function(event){
			var mouse_pos	= mouse_pos_get(event);
			// convert the pixel position in element into [0,1]
			var mouse_y	= mouse_pos.y / canvas_h;
			var val = document.getElementById('text').value;
			var msg_data	= {
				type	: "userInput"
				data	: {
					pos_y	: mouse_y
				}
			}
			socket.send(JSON.stringify(msg_data));
		}
	}
	
	// call the constructor
	ctor();	
	// return the public function
	return {
		
	}
}

jQuery(function(){
	var game	= new Game();	
});

jQuery(function(){
	return;
	socket = new io.Socket('localhost', {port: 8080});
	socket.on('connect', function(){
		// connected
		console.log("connected");
	});
	socket.on('message', function(message){
		console.log("message="+message);
		var data	= JSON.parse(message);
		console.log('got some data');
		console.dir(data);
	});
	socket.connect();
	socket.send('some data');
})
</script>
</body>
</html>
